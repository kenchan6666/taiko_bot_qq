# Temperature 参数详解

**更新日期**: 2026-01-10  
**目的**: 详细解释 Temperature 参数的含义和作用

---

## 什么是 Temperature？

**Temperature（温度）** 是控制 LLM 生成文本时**随机性/创造性**的参数。

### 基本概念

Temperature 控制模型在生成每个词时的**选择策略**：
- **低 Temperature**: 模型更倾向于选择**概率最高**的词（更确定、一致）
- **高 Temperature**: 模型更倾向于选择**概率较低但有趣**的词（更随机、有创造性）

---

## Temperature 值范围和作用

### 标准范围: 0.0 - 2.0

| Temperature 值 | 特点 | 适用场景 | 示例 |
|---------------|------|---------|------|
| **0.0 - 0.3** | 非常确定，几乎总是相同回复 | 需要准确性的任务（分析、总结） | 历史分析、RLHF 选择 |
| **0.4 - 0.6** | 比较确定，但有一定变化 | 需要一致性但也要多样性的任务 | 歌曲查询（准确性重要） |
| **0.7 - 0.9** | 平衡创造性和一致性 | **推荐用于对话**（朋友/常客） | 普通对话、记忆对话 |
| **0.9 - 1.2** | 创造性较强，回复多样化 | 需要创造性的对话 | 活泼对话、调侃 |
| **1.2 - 1.5** | 非常随机，可能不太连贯 | 实验性对话 | 不推荐 |
| **1.5 - 2.0** | 极其随机，经常不连贯 | 几乎不可用 | 不推荐 |

---

## 不同模型的 Temperature 敏感性

### 1. GPT-4o
- **推荐范围**: 0.7 - 0.9
- **特点**: 对 temperature 相对不敏感
- **说明**: 即使在 0.9 也能保持较好的连贯性

### 2. Claude 3.5 Sonnet ⭐（当前使用）
- **推荐范围**: 0.8 - 1.0
- **特点**: **对 temperature 更敏感**
- **说明**: 
  - 低于 0.7 可能显得"太机器人"或"太重复"
  - 0.8-0.95 能产生更自然、更像真人的回复
  - 高于 1.0 可能变得不连贯

### 3. Grok 2
- **推荐范围**: 0.6 - 0.8
- **特点**: 本身就很活泼，建议**降低** temperature 来减少幻觉
- **说明**: 
  - 由于幻觉率高（4.8%），建议降低 temperature 来提高准确性
  - 0.6-0.7 能保持活泼的同时减少错误

---

## 当前配置说明

### 主要对话 (step4.py)

**基础 Temperature**: `0.8`（适合 Claude 3.5 Sonnet）

**根据关系调整**:
- **新用户**: `0.8` - 平衡，不会太创意也不会太无聊
- **熟人**: `0.9` - 稍微增加创意，但保持连贯
- **朋友/常客**: `0.95` - 更创意多样，像真人朋友聊天

**代码位置**: `src/steps/step4.py` 第 407-419 行

```python
base_temperature = 0.8  # Claude 推荐值（比 GPT-4o 的 0.7 稍高）

if context.relationship_status in ["friend", "regular"]:
    temperature = 0.95  # 朋友：更创意多样
elif context.relationship_status == "acquaintance":
    temperature = 0.9   # 熟人：稍微创意
else:
    temperature = 0.8   # 新用户：平衡
```

### 历史分析 (step4.py)

**Temperature**: `0.5` - 较低温度

**原因**:
- ✅ 需要**准确性**，不能有错误
- ✅ 需要**一致性**，同样的历史应该得出相似的分析
- ✅ 不需要创造性，只需要准确总结

**代码位置**: `src/steps/step4.py` 第 732 行

### Self-Reflection (step4.py)

**Temperature**: `0.8` - 中等温度

**原因**:
- ✅ 需要**思考性**，不能太死板
- ✅ 但也要**一致性**，不能太随机
- ✅ 平衡：既能思考，又能保持客观

**代码位置**: `src/steps/step4.py` 第 644 行

### RLHF 选择 (step4.py)

**Temperature**: `0.3` - 非常低

**原因**:
- ✅ 需要**客观性**，选择最像真人的回复
- ✅ 需要**一致性**，同样的候选应该得出相似的选择
- ✅ 不能太创意，要准确判断

**代码位置**: `src/steps/step4.py` 第 880 行

---

## 实际效果对比

### 低 Temperature (0.5)

**输入**: "Mika，你好！"

**回复**:
```
(挥手) 你好！我是 Mika，一个打太鼓的玩家。
```
- ✅ 准确、一致
- ❌ 可能显得"机器人"
- ❌ 回复可能重复

---

### 中等 Temperature (0.8) - 推荐

**输入**: "Mika，你好！"

**回复**:
```
(开心挥手) 哈！你好呀～我是 Mika，一个打太鼓的玩家！你今天怎么样？
```
- ✅ 自然、友好
- ✅ 有变化，不重复
- ✅ 像真人说话

---

### 高 Temperature (1.0)

**输入**: "Mika，你好！"

**回复**:
```
(兴奋地挥手) 哇！你好你好！(突然想起什么) 啊对了，我是 Mika，一个打太鼓的玩家呢！你今天玩太鼓了吗？(好奇地歪头)
```
- ✅ 非常活泼、有创意
- ✅ 回复多样化
- ⚠️ 可能有点"太活泼"或不够连贯

---

## 调整建议

### 如果觉得"不够活泼"

**提高 Temperature**:
```python
# 在 src/steps/step4.py 第 407 行
base_temperature = 0.9  # 从 0.8 提高到 0.9

# 朋友/常客可以更高
temperature = base_temperature + 0.15  # 1.05
```

**效果**: 
- ✅ 回复更活泼、有创意
- ⚠️ 可能稍微不够连贯

---

### 如果觉得"太活泼"或"不连贯"

**降低 Temperature**:
```python
# 在 src/steps/step4.py 第 407 行
base_temperature = 0.7  # 从 0.8 降低到 0.7

# 朋友/常客也降低
temperature = base_temperature + 0.1  # 0.8
```

**效果**:
- ✅ 回复更稳定、连贯
- ⚠️ 可能显得"太机器人"或重复

---

### 如果使用 GPT-4o（切换回去）

**Temperature**: `0.7 - 0.9`

```python
base_temperature = 0.7  # GPT-4o 推荐值（比 Claude 低）
```

**原因**: GPT-4o 对 temperature 相对不敏感，0.7 就够了。

---

### 如果使用 Grok 2

**Temperature**: `0.6 - 0.7`

```python
base_temperature = 0.6  # Grok 推荐值（更低，减少幻觉）
```

**原因**: 
- Grok 本身就很活泼，不需要太高的 temperature
- 降低 temperature 可以减少幻觉率（4.8% → 更低）

---

## 不同场景的 Temperature 建议

| 场景 | 推荐 Temperature | 原因 |
|------|-----------------|------|
| **普通对话** | 0.8 - 0.9 | 平衡创造性和一致性 |
| **朋友/常客对话** | 0.9 - 1.0 | 更活泼、多样化 |
| **新用户对话** | 0.7 - 0.8 | 更稳定、不会太奇怪 |
| **歌曲查询** | 0.6 - 0.7 | 需要准确性，不能出错 |
| **图片分析** | 0.5 - 0.7 | 需要准确性 |
| **历史分析** | 0.5 | 需要准确性，不能有错误 |
| **Self-Reflection** | 0.8 | 需要思考但也要客观 |
| **RLHF 选择** | 0.3 | 需要客观、准确的选择 |

---

## 常见问题

### Q1: Temperature 越高越好吗？

**A**: 不是！太高会不连贯。推荐范围是 0.7-1.0（对话），0.5-0.7（需要准确性）。

### Q2: Claude 为什么需要更高的 Temperature？

**A**: Claude 对 temperature 更敏感。低于 0.7 可能显得"太机器人"，0.8-0.95 能产生更自然的回复。

### Q3: 如何找到最佳的 Temperature？

**A**: 
1. 从 0.8 开始（Claude 推荐值）
2. 测试不同场景（新用户、朋友等）
3. 根据用户反馈调整（+0.1 或 -0.1）
4. 观察效果：如果"不够活泼"就提高，如果"太随机"就降低

### Q4: Temperature 会影响成本吗？

**A**: 不会！Temperature 只影响生成的**质量/风格**，不影响 token 数量或成本。

### Q5: 可以动态调整 Temperature 吗？

**A**: 可以！当前代码已经根据**关系状态**动态调整（新用户、熟人、朋友）。你也可以根据其他条件（消息类型、时间等）调整。

---

## 总结

### 当前配置（Claude 3.5 Sonnet）:
- ✅ **基础**: `0.8` - 适合 Claude，平衡创造性和一致性
- ✅ **新用户**: `0.8` - 稳定、友好
- ✅ **熟人**: `0.9` - 稍微创意
- ✅ **朋友/常客**: `0.95` - 更活泼、多样化

### 关键要点:
1. ✅ Temperature 控制**随机性/创造性**，范围 0.0-2.0
2. ✅ Claude 对 temperature **更敏感**，推荐 0.8-1.0
3. ✅ 不同场景需要不同 temperature（对话 vs 分析）
4. ✅ 根据用户反馈调整，找到最佳值

---

**最后更新**: 2026-01-10  
**相关文件**: 
- `src/steps/step4.py` - Temperature 配置
- `src/services/llm.py` - LLM 服务（temperature 参数）
- `HOW_TO_SWITCH_MODEL.md` - 模型切换指南
