# Mika Bot 运行清单

## 📋 完整运行依赖清单

运行这个 bot 需要以下服务和组件：

---

## 🐳 Docker Compose 服务（必须运行）

这些服务已经包含在 `docker-compose.yml` 中，使用 `docker compose up -d` 启动：

### 1. **MongoDB** (`mika_bot_mongodb`)
- **用途**: 存储用户数据、对话历史、用户印象
- **端口**: `27017`
- **启动命令**: 包含在 `docker compose up -d` 中
- **验证**: `docker ps | grep mongodb`

### 2. **PostgreSQL** (`mika_bot_postgresql`)
- **用途**: Temporal 工作流引擎的状态存储
- **端口**: `5432`
- **启动命令**: 包含在 `docker compose up -d` 中
- **验证**: `docker ps | grep postgresql`

### 3. **Temporal Server** (`mika_bot_temporal`)
- **用途**: 工作流编排引擎，处理消息处理流程
- **端口**: 
  - gRPC: `7233`
  - Web UI: `8088`
- **启动命令**: 包含在 `docker compose up -d` 中
- **验证**: 
  - 容器运行: `docker ps | grep temporal`
  - Web UI: 浏览器访问 http://localhost:8088
- **注意**: Temporal 需要 30-60 秒才能完全启动

### 4. **FastAPI Backend** (`mika_bot_backend`) ⚠️ 可选
- **用途**: 处理 HTTP webhook，调用 LLM API
- **端口**: `8000`
- **启动方式**:
  - **方式 1（推荐）**: 使用 Docker Compose（包含在 `docker compose up -d` 中）
  - **方式 2**: 本地运行（开发时更灵活）
    ```bash
    poetry run uvicorn src.api.main:app --reload --host 0.0.0.0 --port 8000
    ```
- **验证**: 访问 http://localhost:8000/docs

### 5. **Temporal Worker** (`mika_bot_temporal_worker`) ⚠️ 可选
- **用途**: 执行 Temporal 工作流和活动
- **启动方式**:
  - **方式 1（推荐）**: 使用 Docker Compose（包含在 `docker compose up -d` 中）
  - **方式 2**: 本地运行（开发时更容易调试）
    ```bash
    poetry run python -m src.workers.temporal_worker
    ```
- **验证**: 终端显示 "Worker started" 和 "temporal_client_connected"

---

## 🔧 本地运行服务（开发推荐）

如果你想在本地运行 FastAPI 和 Worker（而不是 Docker），需要：

### 1. **FastAPI** (必须)
```bash
# 新开一个终端
poetry run uvicorn src.api.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. **Temporal Worker** (必须)
```bash
# 再开一个终端
poetry run python -m src.workers.temporal_worker
```

**注意**: 如果使用 Docker Compose 运行 backend 和 worker，则不需要本地运行这两个服务。

---

## 🌐 外部服务（必须单独部署）

这些服务**不包含**在 `docker-compose.yml` 中，需要单独部署：

### 1. **LangBot** (必须) ⚠️ 外部服务
- **用途**: QQ 机器人平台，接收 QQ 消息并发送 webhook
- **部署方式**: 单独安装和运行（不在本项目中）
- **配置要求**:
  - Webhook URL 指向 FastAPI: `http://your-backend:8000/webhook/langbot`
  - 关键词触发: `(?i)(mika|米卡|mika酱)`
  - 群组白名单（可选）
- **文档**: 查看 `LANGBOT_CONFIGURATION.md`

### 2. **Napcat** (可选，但推荐) ⚠️ 外部服务
- **用途**: QQ 协议层，保持机器人账号在线
- **部署方式**: 单独安装和运行（不在本项目中）
- **文档**: 查看 `EXTERNAL_SERVICES_DEPLOYMENT.md`

### 3. **ngrok** (开发时推荐) ⚠️ 外部工具
- **用途**: 本地开发时暴露 FastAPI 到公网，让 LangBot 可以访问
- **安装**: 下载并安装 ngrok
- **使用**:
  ```bash
  ngrok http 8000
  ```
- **配置**: 将 ngrok 生成的 HTTPS URL 配置到 LangBot 的 webhook URL
- **注意**: 生产环境不需要，应使用真实的公网域名/IP

---

## 🔑 环境变量配置（必须）

创建 `.env` 文件并配置以下关键变量：

### 必须配置：
```bash
# OpenRouter API Key (用于调用 gpt-4o)
OPENROUTER_API_KEY=your_openrouter_api_key_here

# LangBot 配置（如果使用）
LANGBOT_API_KEY=your_langbot_api_key
LANGBOT_API_BASE_URL=http://localhost:5300  # LangBot 的地址
LANGBOT_WEBHOOK_URL=http://localhost:8000/webhook/langbot
LANGBOT_ALLOWED_GROUPS=123456789,987654321  # 允许的群组 ID（可选）
```

### 可选配置：
```bash
# 机器人名称
BOT_NAME=Mika

# 日志级别
LOG_LEVEL=INFO

# MongoDB 配置（默认即可）
MONGODB_URL=mongodb://localhost:27017/
MONGODB_DATABASE=mika_bot

# Temporal 配置（默认即可）
TEMPORAL_HOST=localhost
TEMPORAL_PORT=7233
TEMPORAL_NAMESPACE=default
```

---

## 🚀 快速启动步骤

### 方式 1: 使用 Docker Compose（推荐生产环境）

```bash
# 1. 启动所有 Docker 服务（MongoDB, PostgreSQL, Temporal, Backend, Worker）
docker compose up -d

# 2. 等待 60 秒让 Temporal 完全启动

# 3. 验证服务
docker ps  # 所有容器应该都是 "Up" 状态
curl http://localhost:8000/health  # FastAPI 健康检查

# 4. 如果需要本地访问，启动 ngrok（开发时）
ngrok http 8000

# 5. 配置 LangBot 的 webhook URL（使用 ngrok URL 或生产域名）
```

### 方式 2: 混合模式（推荐开发环境）

```bash
# 1. 启动基础服务（MongoDB, PostgreSQL, Temporal）
docker compose up -d mongodb postgresql temporal

# 2. 等待 60 秒让 Temporal 完全启动

# 3. 本地运行 FastAPI（新终端）
poetry run uvicorn src.api.main:app --reload --host 0.0.0.0 --port 8000

# 4. 本地运行 Worker（新终端）
poetry run python -m src.workers.temporal_worker

# 5. 启动 ngrok（开发时，新终端）
ngrok http 8000

# 6. 配置 LangBot
```

---

## ✅ 启动检查清单

启动前确保：

- [ ] Docker Desktop 正在运行
- [ ] 环境变量已配置（`.env` 文件）
- [ ] `OPENROUTER_API_KEY` 已设置
- [ ] MongoDB 容器运行中（`docker ps | grep mongodb`）
- [ ] PostgreSQL 容器运行中（`docker ps | grep postgresql`）
- [ ] Temporal 容器运行中（`docker ps | grep temporal`）
- [ ] Temporal Web UI 可访问 (http://localhost:8088)
- [ ] FastAPI 运行中 (http://localhost:8000/docs)
- [ ] Temporal Worker 运行中（终端显示 "Worker started"）
- [ ] LangBot 已配置并运行（外部服务）
- [ ] LangBot webhook URL 正确配置
- [ ] ngrok 运行中（仅开发环境）

---

## 📊 服务端口汇总

| 服务 | 端口 | 用途 | 是否必须 |
|------|------|------|----------|
| MongoDB | 27017 | 数据库 | ✅ 必须 |
| PostgreSQL | 5432 | Temporal 状态存储 | ✅ 必须 |
| Temporal gRPC | 7233 | 工作流引擎 | ✅ 必须 |
| Temporal Web UI | 8088 | 监控界面 | 推荐 |
| FastAPI | 8000 | HTTP API | ✅ 必须 |
| ngrok | - | 公网隧道（开发） | 开发时必须 |

---

## 🛑 停止服务

```bash
# 停止所有 Docker 服务
docker compose down

# 停止并删除数据卷（⚠️ 会删除数据）
docker compose down -v

# 如果本地运行了 FastAPI 或 Worker，按 Ctrl+C 停止
```

---

## 📝 运行模式对比

### 生产环境（推荐）
- ✅ 所有服务在 Docker 中运行
- ✅ 使用真实的公网域名/IP
- ✅ 不需要 ngrok
- ✅ 更稳定，易于管理

### 开发环境（推荐）
- ✅ 基础服务（MongoDB, PostgreSQL, Temporal）在 Docker 中
- ✅ FastAPI 和 Worker 本地运行（更容易调试）
- ✅ 使用 ngrok 暴露本地服务
- ✅ 更灵活，热重载

---

## 🔍 验证所有服务正在运行

运行以下命令检查：

```bash
# 检查 Docker 容器
docker ps

# 应该看到：
# - mika_bot_mongodb
# - mika_bot_postgresql
# - mika_bot_temporal
# - mika_bot_backend（如果使用 Docker）
# - mika_bot_temporal_worker（如果使用 Docker）

# 检查 FastAPI
curl http://localhost:8000/health

# 检查 Temporal Web UI
curl http://localhost:8088

# 检查 Worker（查看日志）
docker logs mika_bot_temporal_worker --tail 20
# 或如果本地运行，查看终端输出
```

---

## ⚠️ 常见问题

### 问题: Temporal 容器一直重启
**解决**: 等待 60 秒，Temporal 需要较长时间启动

### 问题: Worker 无法连接
**解决**: 
1. 确认 Temporal Server 已完全启动（访问 http://localhost:8088）
2. 等待 60 秒后再启动 Worker
3. 检查 `TEMPORAL_HOST` 和 `TEMPORAL_PORT` 配置

### 问题: LangBot 无法访问 webhook
**解决**:
1. 开发环境: 使用 ngrok 暴露本地 8000 端口
2. 生产环境: 确保防火墙允许 8000 端口，或使用 Nginx 反向代理
3. 检查 LangBot 配置的 webhook URL 是否正确

---

**提示**: 详细文档请参考：
- `START_SERVICES.md` - 服务启动指南
- `LANGBOT_CONFIGURATION.md` - LangBot 配置
- `EXTERNAL_SERVICES_DEPLOYMENT.md` - 外部服务部署
- `TROUBLESHOOTING.md` - 故障排查
