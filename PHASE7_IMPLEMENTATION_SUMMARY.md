# Phase 7 å®ç°æ€»ç»“ - Intent Classification & Scenario-Based Prompting

**å®Œæˆæ—¥æœŸ**: 2026-01-08  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ å®ç°æ¦‚è¿°

Phase 7 å®ç°äº†ç»†ç²’åº¦æ„å›¾åˆ†ç±»å’Œåœºæ™¯åŒ–æç¤ºç³»ç»Ÿï¼Œä½¿æœºå™¨äººèƒ½å¤Ÿæ ¹æ®ç”¨æˆ·æ„å›¾å’Œåœºæ™¯é€‰æ‹©æ›´åˆé€‚çš„æç¤ºæ¨¡æ¿ï¼Œæä¾›æ›´ä¸Šä¸‹æ–‡ç›¸å…³çš„å“åº”ã€‚

---

## âœ… å·²å®Œæˆçš„ä»»åŠ¡

### T065A: å¢å¼ºæ„å›¾æ£€æµ‹ç³»ç»Ÿ âœ…

**æ–‡ä»¶**: `src/services/intent_detection.py`

**å®ç°å†…å®¹**:
- âœ… å®Œå–„äº†ç»†ç²’åº¦æ„å›¾åˆ†ç±»ï¼ˆ12ç§æ„å›¾ç±»å‹ï¼‰
- âœ… æ·»åŠ äº†åœºæ™¯æ£€æµ‹åŠŸèƒ½ï¼ˆ6ç§åœºæ™¯ç±»å‹ï¼‰
- âœ… å®ç°äº† `detect_intent_and_scenario()` ç»„åˆæ–¹æ³•
- âœ… æ·»åŠ äº†ç»“æ„åŒ–æ—¥å¿—è®°å½•
- âœ… æ”¯æŒ LLM å›é€€åˆ†ç±»ï¼ˆå¯é€‰ï¼‰

**æ”¯æŒçš„æ„å›¾ç±»å‹**:
- **å¯¹è¯ç±»**: greeting, help, goodbye, preference_confirmation, clarification_request
- **æ­Œæ›²ç±»**: song_query, song_recommendation, difficulty_advice, bpm_analysis
- **æ¸¸æˆç±»**: game_tips, achievement_celebration, practice_advice

**æ”¯æŒçš„åœºæ™¯ç±»å‹**:
- **æ­Œæ›²æ¨èåœºæ™¯**: song_recommendation_high_bpm, song_recommendation_beginner_friendly
- **éš¾åº¦å»ºè®®åœºæ™¯**: difficulty_advice_beginner, difficulty_advice_expert
- **æ¸¸æˆæŠ€å·§åœºæ™¯**: game_tips_timing, game_tips_accuracy

---

### T065B: æ·»åŠ æ„å›¾ç‰¹å®šçš„æç¤ºæ¨¡æ¿ âœ…

**æ–‡ä»¶**: `src/prompts.py` (å‡½æ•°: `_initialize_intent_specific_prompts()`)

**å®ç°å†…å®¹**:
- âœ… æ·»åŠ äº† 8 ä¸ªæ„å›¾ç‰¹å®šçš„æç¤ºæ¨¡æ¿
- âœ… æ¯ä¸ªæ¨¡æ¿éƒ½åŒ…å«å¯¹è¯å†å²ã€ç”¨æˆ·åå¥½ç­‰ä¸Šä¸‹æ–‡
- âœ… æ”¯æŒå¤šè¯­è¨€ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰

**å·²æ·»åŠ çš„æ„å›¾æç¤º**:
1. `intent_greeting` - é—®å€™æ„å›¾
2. `intent_help` - å¸®åŠ©è¯·æ±‚
3. `intent_goodbye` - å‘Šåˆ«
4. `intent_song_recommendation` - æ­Œæ›²æ¨è
5. `intent_difficulty_advice` - éš¾åº¦å»ºè®®
6. `intent_bpm_analysis` - BPM åˆ†æ
7. `intent_game_tips` - æ¸¸æˆæŠ€å·§
8. `intent_achievement_celebration` - æˆå°±åº†ç¥
9. `intent_practice_advice` - ç»ƒä¹ å»ºè®®

---

### T065C: æ·»åŠ åœºæ™¯åŒ–æç¤ºæ¨¡æ¿ âœ…

**æ–‡ä»¶**: `src/prompts.py` (å‡½æ•°: `_initialize_scenario_based_prompts()`)

**å®ç°å†…å®¹**:
- âœ… æ·»åŠ äº† 6 ä¸ªåœºæ™¯åŒ–æç¤ºæ¨¡æ¿
- âœ… æ¯ä¸ªåœºæ™¯æ¨¡æ¿é’ˆå¯¹ç‰¹å®šä¸Šä¸‹æ–‡ä¼˜åŒ–
- âœ… åŒ…å«åœºæ™¯ç‰¹å®šçš„æŒ‡å¯¼å’Œå»ºè®®

**å·²æ·»åŠ çš„åœºæ™¯æç¤º**:
1. `scenario_song_recommendation_high_bpm` - é«˜ BPM æ­Œæ›²æ¨è
2. `scenario_song_recommendation_beginner_friendly` - æ–°æ‰‹å‹å¥½æ¨è
3. `scenario_difficulty_advice_beginner` - æ–°æ‰‹éš¾åº¦å»ºè®®
4. `scenario_difficulty_advice_expert` - ä¸“å®¶éš¾åº¦å»ºè®®
5. `scenario_game_tips_timing` - èŠ‚å¥æŠ€å·§
6. `scenario_game_tips_accuracy` - å‡†ç¡®åº¦æŠ€å·§

---

### T065D: æ›´æ–°æç¤ºé€‰æ‹©é€»è¾‘ âœ…

**æ–‡ä»¶**: `src/steps/step4.py`

**å®ç°å†…å®¹**:
- âœ… å®ç°äº†ä¼˜å…ˆçº§æç¤ºé€‰æ‹©é€»è¾‘ï¼š
  1. **åœºæ™¯åŒ–æç¤º** (æœ€é«˜ä¼˜å…ˆçº§)
  2. **æ„å›¾ç‰¹å®šæç¤º**
  3. **use_case æç¤º** (memory_aware / general_chat)
- âœ… æ·»åŠ äº†ç»“æ„åŒ–æ—¥å¿—è®°å½•
- âœ… å®ç°äº†ä¼˜é›…é™çº§ï¼ˆfallbackï¼‰
- âœ… è®°å½•æ„å›¾æ£€æµ‹å¤±è´¥ä»¥ä¾¿åˆ†æ

**æç¤ºé€‰æ‹©æµç¨‹**:
```
å›¾åƒè¯·æ±‚ â†’ å›¾åƒåˆ†ææç¤º
    â†“
æ­Œæ›²æŸ¥è¯¢ â†’ æ­Œæ›²æŸ¥è¯¢æç¤º
    â†“
åœºæ™¯æ£€æµ‹ â†’ åœºæ™¯åŒ–æç¤º (å¦‚: scenario_song_recommendation_high_bpm)
    â†“
æ„å›¾æ£€æµ‹ â†’ æ„å›¾ç‰¹å®šæç¤º (å¦‚: intent_song_recommendation)
    â†“
è®°å¿†ä¸Šä¸‹æ–‡ â†’ è®°å¿†æ„ŸçŸ¥æç¤º (memory_aware)
    â†“
é»˜è®¤ â†’ é€šç”¨èŠå¤©æç¤º (general_chat)
```

---

### T065E: é›†æˆæ„å›¾æ£€æµ‹åˆ° step1 âœ…

**æ–‡ä»¶**: `src/steps/step1.py`, `src/api/routes/langbot.py`, `src/activities/step1_activity.py`

**å®ç°å†…å®¹**:
- âœ… å°† `parse_input` æ”¹ä¸ºå¼‚æ­¥å‡½æ•°ï¼ˆæ”¯æŒå¼‚æ­¥æ„å›¾æ£€æµ‹ï¼‰
- âœ… åœ¨ `parse_input` ä¸­é›†æˆæ„å›¾å’Œåœºæ™¯æ£€æµ‹
- âœ… æ›´æ–° `ParsedInput` ç±»æ·»åŠ  `intent` å’Œ `scenario` å­—æ®µ
- âœ… æ›´æ–°æ‰€æœ‰è°ƒç”¨ç‚¹ä½¿ç”¨ `await`
- âœ… æ›´æ–° activity åºåˆ—åŒ–åŒ…å« intent å’Œ scenario

**å…³é”®å˜æ›´**:
- `parse_input()` ç°åœ¨æ˜¯ `async def`
- æ·»åŠ äº†æ„å›¾æ£€æµ‹é”™è¯¯å¤„ç†ï¼ˆéé˜»å¡ï¼‰
- æ„å›¾æ£€æµ‹å¤±è´¥æ—¶ç»§ç»­ä½¿ç”¨ use_case æç¤º

---

### T065F: å•å…ƒæµ‹è¯• âœ…

**æ–‡ä»¶**: `tests/unit/test_intent_detection.py`

**æµ‹è¯•è¦†ç›–**:
- âœ… æ„å›¾æ£€æµ‹ï¼ˆè§„åˆ™åŒ¹é…ï¼‰
- âœ… åœºæ™¯æ£€æµ‹
- âœ… LLM å›é€€åˆ†ç±»
- âœ… é”™è¯¯å¤„ç†
- âœ… ç»„åˆæ£€æµ‹ï¼ˆintent + scenarioï¼‰
- âœ… å…¨å±€æœåŠ¡å®ä¾‹

**æµ‹è¯•ç”¨ä¾‹**: 20+ ä¸ªæµ‹è¯•ç”¨ä¾‹

---

### T065G: é›†æˆæµ‹è¯• âœ…

**æ–‡ä»¶**: `tests/integration/test_intent_prompt_selection.py`

**æµ‹è¯•è¦†ç›–**:
- âœ… ç«¯åˆ°ç«¯æ„å›¾æç¤ºé€‰æ‹©
- âœ… åœºæ™¯åŒ–æç¤ºä¼˜å…ˆçº§
- âœ… å›é€€åˆ° use_case æç¤º
- âœ… è®°å¿†ä¸Šä¸‹æ–‡é›†æˆ
- âœ… æ—¥å¿—éªŒè¯

**æµ‹è¯•ç”¨ä¾‹**: 6 ä¸ªé›†æˆæµ‹è¯•

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. æ„å›¾æ£€æµ‹å¢å¼º

```python
# æ–°å¢æ–¹æ³•
async def detect_intent_and_scenario(
    self,
    message: str,
    use_llm: bool = False,
) -> Tuple[Optional[str], Optional[str]]:
    """åŒæ—¶æ£€æµ‹æ„å›¾å’Œåœºæ™¯"""
    intent = await self.detect_intent(message, use_llm)
    scenario = self.detect_scenario(message, intent=intent)
    return intent, scenario
```

### 2. æç¤ºé€‰æ‹©ä¼˜å…ˆçº§

```python
# ä¼˜å…ˆçº§é¡ºåºï¼ˆstep4.pyï¼‰
if parsed_input.scenario:
    # 1. åœºæ™¯åŒ–æç¤ºï¼ˆæœ€å…·ä½“ï¼‰
    prompt = get_prompt(f"scenario_{parsed_input.scenario}")
elif parsed_input.intent:
    # 2. æ„å›¾ç‰¹å®šæç¤º
    prompt = get_prompt(f"intent_{parsed_input.intent}")
elif has_memory_context:
    # 3. è®°å¿†æ„ŸçŸ¥æç¤º
    prompt = get_prompt("memory_aware")
else:
    # 4. é€šç”¨èŠå¤©æç¤º
    prompt = get_prompt("general_chat")
```

### 3. å¼‚æ­¥é›†æˆ

```python
# step1.py - å¼‚æ­¥æ„å›¾æ£€æµ‹
intent, scenario = await intent_service.detect_intent_and_scenario(
    message=message,
    use_llm=False,
)
```

---

## ğŸ“Š ä»£ç è´¨é‡

- âœ… **ç±»å‹æ³¨è§£**: æ‰€æœ‰å‡½æ•°éƒ½æœ‰å®Œæ•´çš„ç±»å‹æ³¨è§£
- âœ… **ä»£ç æ³¨é‡Š**: æ·»åŠ äº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š
- âœ… **Black æ ¼å¼åŒ–**: ä»£ç ç¬¦åˆ Black æ ¼å¼è§„èŒƒ
- âœ… **é”™è¯¯å¤„ç†**: å®ç°äº†ä¼˜é›…é™çº§å’Œé”™è¯¯æ—¥å¿—
- âœ… **æ—¥å¿—è®°å½•**: ä½¿ç”¨ structlog è¿›è¡Œç»“æ„åŒ–æ—¥å¿—

---

## ğŸ§ª æµ‹è¯•çŠ¶æ€

### å•å…ƒæµ‹è¯•
- âœ… `tests/unit/test_intent_detection.py` - 20+ æµ‹è¯•ç”¨ä¾‹
- âœ… è¦†ç›–æ‰€æœ‰æ„å›¾ç±»å‹
- âœ… è¦†ç›–æ‰€æœ‰åœºæ™¯ç±»å‹
- âœ… æµ‹è¯• LLM å›é€€
- âœ… æµ‹è¯•é”™è¯¯å¤„ç†

### é›†æˆæµ‹è¯•
- âœ… `tests/integration/test_intent_prompt_selection.py` - 6 ä¸ªæµ‹è¯•ç”¨ä¾‹
- âœ… ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•
- âœ… å›é€€åœºæ™¯æµ‹è¯•
- âœ… è®°å¿†ä¸Šä¸‹æ–‡é›†æˆæµ‹è¯•

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: é—®å€™æ„å›¾

```python
# ç”¨æˆ·æ¶ˆæ¯: "Mika, ä½ å¥½ï¼"
# æ£€æµ‹ç»“æœ:
# - intent: "greeting"
# - scenario: None
# é€‰æ‹©çš„æç¤º: intent_greeting
```

### ç¤ºä¾‹ 2: é«˜ BPM æ­Œæ›²æ¨è

```python
# ç”¨æˆ·æ¶ˆæ¯: "Mika, æ¨èä¸€äº›é«˜ BPM çš„æ­Œæ›²"
# æ£€æµ‹ç»“æœ:
# - intent: "song_recommendation"
# - scenario: "song_recommendation_high_bpm"
# é€‰æ‹©çš„æç¤º: scenario_song_recommendation_high_bpm (ä¼˜å…ˆçº§æœ€é«˜)
```

### ç¤ºä¾‹ 3: å›é€€åœºæ™¯

```python
# ç”¨æˆ·æ¶ˆæ¯: "Mika, random message"
# æ£€æµ‹ç»“æœ:
# - intent: None
# - scenario: None
# é€‰æ‹©çš„æç¤º: general_chat (å›é€€åˆ° use_case æç¤º)
```

---

## ğŸ”„ å‘åå…¼å®¹æ€§

- âœ… æ‰€æœ‰ç°æœ‰åŠŸèƒ½ä¿æŒä¸å˜
- âœ… æ„å›¾æ£€æµ‹å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°åŸæœ‰é€»è¾‘
- âœ… ä¸ç ´åç°æœ‰çš„æç¤ºæ¨¡æ¿ç³»ç»Ÿ
- âœ… æ”¯æŒæ¸è¿›å¼é‡‡ç”¨ï¼ˆå¯ä»¥é€æ­¥å¯ç”¨ LLM åˆ†ç±»ï¼‰

---

## ğŸ“ˆ æ€§èƒ½å½±å“

- **æ„å›¾æ£€æµ‹**: è§„åˆ™åŒ¹é…éå¸¸å¿«ï¼ˆ< 1msï¼‰
- **åœºæ™¯æ£€æµ‹**: åŒæ­¥æ“ä½œï¼Œæ— æ€§èƒ½å½±å“
- **LLM åˆ†ç±»**: å¯é€‰åŠŸèƒ½ï¼Œé»˜è®¤å…³é—­
- **æç¤ºé€‰æ‹©**: ç®€å•çš„å­—å…¸æŸ¥æ‰¾ï¼Œæ— æ€§èƒ½å½±å“

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

1. **ç›‘æ§å’Œåˆ†æ**:
   - æ”¶é›†æ„å›¾æ£€æµ‹æˆåŠŸç‡
   - åˆ†æå›é€€é¢‘ç‡
   - ä¼˜åŒ–è§„åˆ™æ¨¡å¼

2. **LLM åˆ†ç±»ä¼˜åŒ–**:
   - è¯„ä¼°ä½•æ—¶å¯ç”¨ LLM åˆ†ç±»
   - ä¼˜åŒ– LLM æç¤ºè¯
   - ç¼“å­˜å¸¸è§åˆ†ç±»ç»“æœ

3. **æ›´å¤šåœºæ™¯**:
   - æ ¹æ®ä½¿ç”¨æƒ…å†µæ·»åŠ æ›´å¤šåœºæ™¯
   - ä¼˜åŒ–ç°æœ‰åœºæ™¯æ¨¡å¼

---

## âœ… æ£€æŸ¥ç‚¹éªŒè¯

- [x] æ„å›¾åˆ†ç±»ç³»ç»Ÿè¿è¡Œæ­£å¸¸
- [x] åœºæ™¯åŒ–æç¤ºé€‰æ‹©å·¥ä½œæ­£å¸¸
- [x] å›é€€æœºåˆ¶å·¥ä½œæ­£å¸¸
- [x] æ—¥å¿—è®°å½•å®Œæ•´
- [x] æµ‹è¯•è¦†ç›–å……åˆ†
- [x] ä»£ç è´¨é‡ç¬¦åˆè¦æ±‚

---

**Phase 7 å®ç°å®Œæˆï¼** ğŸ‰

ç°åœ¨ç³»ç»Ÿå¯ä»¥æ ¹æ®ç”¨æˆ·æ„å›¾å’Œåœºæ™¯é€‰æ‹©æœ€åˆé€‚çš„æç¤ºæ¨¡æ¿ï¼Œæä¾›æ›´æ™ºèƒ½ã€æ›´ä¸Šä¸‹æ–‡ç›¸å…³çš„å“åº”ã€‚
